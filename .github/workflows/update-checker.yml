name: Update Checker

on:
  workflow_dispatch:
  schedule:
    - cron: '0 20 * * 0'  # 每周日 20:00 (UTC+8)

env:
  REPO_URL: https://github.com/coolsnowwolf/lede
  REPO_BRANCH: master

jobs:
  check:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout current repo
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.ACTIONS_TRIGGER_PAT }}
        ref: ${{ github.ref }}  # 确保检出到当前分支（如 main）

    - name: Fetch latest upstream commit
      id: fetch_upstream
      run: |
        git clone --depth=1 $REPO_URL -b $REPO_BRANCH lede-upstream
        UPSTREAM_HASH=$(cd lede-upstream && git rev-parse HEAD)
        echo "upstream_hash=$UPSTREAM_HASH" >> $GITHUB_OUTPUT

    - name: Read last recorded commit
      id: read_last
      run: |
        if [ -f .last_commit ]; then
          LAST_HASH=$(cat .last_commit)
        else
          LAST_HASH=""
        fi
        echo "last_hash=$LAST_HASH" >> $GITHUB_OUTPUT

    - name: Compare and trigger build if changed
      id: compare
      run: |
        if [ "${{ steps.read_last.outputs.last_hash }}" != "${{ steps.fetch_upstream.outputs.upstream_hash }}" ]; then
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "New commit detected! Triggering build..."
        else
          echo "changed=false" >> $GITHUB_OUTPUT
          echo "No update."
        fi

    - name: Save new commit hash
      if: steps.compare.outputs.changed == 'true'
      run: |
        echo "${{ steps.fetch_upstream.outputs.upstream_hash }}" > .last_commit
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git add .last_commit
        git commit -m "chore: update last_commit to ${{ steps.fetch_upstream.outputs.upstream_hash }}"
        git push

    - name: Dispatch build event
      if: steps.compare.outputs.changed == 'true'
      uses: peter-evans/repository-dispatch@v2
      with:
        token: ${{ secrets.ACTIONS_TRIGGER_PAT }}
        event-type: Source Code Update

    - name: Cleanup
      run: rm -rf lede-upstream
    
